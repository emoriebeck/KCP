---
title: "Detecting Idiographic Personality Change"
author: "Emorie D Beck"
institution: "Washington University in St. Louis"
date: "`r Sys.setlocale('LC_TIME', 'C'); format(Sys.time(), '%d\\\\. %B %Y')`"
output:
  html_document:
    theme: united
    highlight: tango
    df_print: paged
    code_folding: hide
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Workspace
```{r}
packages <- c("psych", "parallel", "plyr", "tidyverse")
new.packages <- packages[!(packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

if(!("results" %in% list.files())){dir.create("~/results")}

library(psych)
library(parallel)
library(plyr)
library(tidyverse)
wd <- "~/Documents/Github/KCP"
read.path <- "https://github.com/emoriebeck/KCP"
write.path <- "~/"
write.path <- wd
```

## Packages

## Functions

## Data

### Create a codebook
```{r}
Big5 <- c("Extraversion", "Agreeableness", "Conscientiousness", "Neuroticism", "Openness")
codebook <- crossing(
  inventory = "tipi",
  traittmp = c("e", "a", "c", "n", "o"),
  week = c(paste("0",1:9, sep = ""), 10:60)
) %>%
  mutate(trait = mapvalues(traittmp, c("e", "a", "c", "n", "o"), Big5),
         type = "personality") %>%
  unite(item, inventory, traittmp, week, sep = "") %>%
full_join(
crossing(
  tmp = "relevents",
  num = c(paste("0", c(3,4,6,8,9), sep = ""), "10", "11")
) %>%
  mutate(trait = mapvalues(num, unique(num), c("famPassed", "partTrav", "pregnant", 
                            "engaged", "moveIn", "married", "brokeUp")),
         type = "event") %>%
  unite(item, tmp, num, sep = "")
)
```


### Load the data
```{r}
# CREATE A COEBOOK
weekly <- url(sprintf("%s/blob/master/data/Longitudinal_Weekly_1_Year/metaresearch2-corrected-web.sav?raw=true", read.path)) %>%
  haven::read_sav()

weekly_long <- weekly %>%
  select(ID, contains("tipi"), contains("relevents")) %>%
  gather(key = item, value = value, -ID, na.rm = T) %>%
  full_join(codebook) %>%
  mutate(week = as.numeric(str_remove_all(item, "[a-z]"))) %>%
  select(-item) %>% 
  filter(value != 0) %>%
  arrange(ID, trait, type, week) 

weekly_wide <- weekly_long %>% 
  filter(type == "personality") %>%
  spread(key = trait, value = value) %>%
  select(-type)
```

# KCP 
```{r}
source(sprintf('%s/blob/master/scripts/functions.R?raw=true', read.path))
start <- Sys.time()
KCP_nested <- weekly_wide %>% 
  group_by(ID) %>%
  mutate(n = n()) %>%
  filter(n > 25) %>%
  select(-n) %>%
  filter(ID %in% c("002", "003", "004")) %>%
  nest() %>%
  mutate(KCP = map2(data, ID, ~KCP(
    data = .x       # N x P numeric matrix or data frame
  , kmax = 3        # max number of change points to test
  , window = 10     # the size of the moving window used for correlations
  , timevar = "week"# name of the time variable for sorting
  , iter = 50       # number of permutations
  , alpha = .05     # "significance criterion"
  , rule = "OR"     # should both variance and variance drop tests be required to be significant
  , perm_path = sprintf("%s/results/perm_data", write.path) # path to save the permuted data sets and moving window correlations to
  , vhat_path = sprintf("%s/results/vhats", write.path) # path to save the v hat values, if desired
  , ID = .y  
  )))
end <- Sys.time()
print(paste("Time elapsed", round(end-start,2)))


```

